# REVIEW 技能规范 - SPEC驱动的代码审查专家

**版本**: 1.0.0
**目的**: 审查代码与SPEC的一致性、代码质量、调试规范符合性
**职责**: 代码审查、SPEC验证、质量检查、改进建议
**最后更新**: 2025-12-27

---

## 🎯 技能定位

**核心价值**：确保代码实现与SPEC完全一致，符合质量和调试规范

**适用场景**：
1. ✅ **代码提交前审查**：手动触发，检查当前分支的代码变更
2. ✅ **Pull Request审查**：审查PR的代码变更
3. ✅ **定期代码巡检**：定期检查代码质量
4. ✅ **Bug修复验证**：验证Bug修复是否彻底

---

## 🛠️ 执行流程

### 步骤0：审查范围检测

**检测当前状态**：
```bash
# 检查Git状态
git status
git branch
git log --oneline -5

# 检查是否有未提交的变更
git diff --name-only
git diff --cached --name-only

# 检查是否在PR中
[ -n "$PR_NUMBER" ] && echo "PR审查" || echo "分支审查"
```

**分类处理**：

| 场景 | 检测方法 | 处理流程 |
|------|---------|----------|
| **未提交变更** | `git status` 有修改 | 审查工作区变更 |
| **已提交未推送** | `git log` 有新提交 | 审查待推送提交 |
| **PR环境** | 环境变量有PR_NUMBER | 审查PR差异 |
| **无变更** | 无任何修改 | 提示无变更可审查 |

---

### 步骤1：代码变更分析

#### 1.1 识别变更文件

**方法**：
```bash
# 获取变更文件列表
git diff --name-only HEAD~1 HEAD  # 最新提交
git diff --name-only                   # 工作区变更
git diff --cached --name-only          # 暂存区变更

# 或使用Explore工具深度分析
Task(
    subagent_type="Explore",
    prompt="""
分析当前代码变更，准备进行SPEC一致性审查。

扫描内容：
- 所有变更的文件路径
- 变更类型（新增/修改/删除）
- 变更行数统计
- 涉及的模块和功能

输出格式：
- 文件清单（路径 + 类型 + 行数）
- 影响范围分析
- 可能涉及的功能模块
"""
)
```

#### 1.2 加载上下文信息

**读取SPEC文档**：
```
SPEC/01-REQUIREMENTS.md   → 关联的REQ-XXX
SPEC/02-ARCHITECTURE.md   → 关联的ARCH-XXX
SPEC/03-DATA-STRUCTURE.md → 关联的DATA-XXX
SPEC/04-API-DESIGN.md     → 关联的API-XXX
SPEC/05-UI-DESIGN.md      → 关联的UI-XXX（如前端）
```

**读取角色规范**：
```
roles/common.md              → 通用编程规范
roles/debugger.md           → 调试规范
roles/quality.md            → 质量规范
roles/frontend-standards.md → 前端规范（如适用）
roles/database-standards.md → 数据库规范（如适用）
```

---

### 步骤2：多维度代码审查

#### 2.1 SPEC一致性审查

**检查项**：
```markdown
## SPEC一致性检查清单

### 代码-SPEC关联检查
- [ ] 代码变更是否关联REQ-XXX？
- [ ] 代码实现是否符合SPEC要求？
- [ ] 是否遗漏SPEC中定义的功能？
- [ ] 是否实现了SPEC中没有的功能？

### ID引用检查
- [ ] 是否正确引用了DATA-XXX？
- [ ] 是否正确引用了API-XXX？
- [ ] 是否正确引用了ARCH-XXX？
- [ ] ID引用格式是否正确？

### 实现完整性检查
- [ ] SPEC要求的验收标准是否满足？
- [ ] 边界条件是否处理？
- [ ] 错误处理是否完整？
```

**评分标准**：
| 问题类型 | 严重程度 | 示例 |
|---------|---------|------|
| ❌ 代码违反SPEC | 严重 | 实现与SPEC定义的接口不一致 |
| ⚠️ 代码不完整 | 主要 | 只实现了部分功能，缺少边界处理 |
| ℹ️ 代码超出SPEC | 次要 | 实现了SPEC中没有定义的功能 |

#### 2.2 代码质量审查（基于quality.md）

**检查项**：
```markdown
## 代码质量检查清单

### 可读性
- [ ] 命名是否符合规范？
- [ ] 函数长度是否<50行？
- [ ] 嵌套深度是否<3层？
- [ ] 注释是否准确有用？

### 可维护性
- [ ] 是否遵循SOLID原则？
- [ ] 模块耦合度是否低？
- [ ] 依赖关系是否清晰？

### 性能
- [ ] 算法效率是否合理？
- [ ] 是否有明显的性能问题？
- [ ] 资源使用是否优化？
```

#### 2.3 调试规范审查（基于debugger.md）

**检查项**：
```markdown
## 调试规范检查清单

### 日志规范
- [ ] 是否有适当的日志记录？
- [ ] 日志级别是否正确（DEBUG/INFO/WARN/ERROR）？
- [ ] 是否包含关键上下文信息？

### 错误处理
- [ ] 是否有完整的错误处理？
- [ ] 是否避免吞掉异常？
- [ ] 错误信息是否有意义？

### 禁止模式
- [ ] 是否有硬编码的调试代码？
- [ ] 是否有临时补丁式修复？
- [ ] 是否有try-catch吞异常？
```

---

### 步骤3：问题汇总与分类

#### 3.1 问题分类

按严重程度分类：

| 严重程度 | 标准 | 示例 |
|---------|------|------|
| **🔴 严重** | 必须修复 | 违反SPEC、缺少错误处理 |
| **🟡 主要** | 建议修复 | 命名不规范、性能问题 |
| **🟢 次要** | 可选优化 | 注释不足、代码风格 |

按问题类型分类：

| 问题类型 | 检查项 | 示例 |
|---------|-------|------|
| **SPEC不一致** | 步骤2.1 | 实现与API-XXX定义不一致 |
| **代码质量** | 步骤2.2 | 函数过长、圈复杂度高 |
| **调试规范** | 步骤2.3 | 缺少日志、错误处理不完整 |

#### 3.2 生成审查报告

**报告格式**：
```markdown
## 📋 代码审查报告

**审查范围**：
- 分支：feature/user-auth
- 提交：abc123...def456
- 文件：5个修改，237行变更

**审查结果**：
- 🔴 严重问题：2个
- 🟡 主要问题：3个
- 🟢 次要问题：1个

---

### 🔴 严重问题（必须修复）

#### 1. [SPEC不一致] API响应格式不符合API-AUTH-001定义
**位置**: `src/auth/service.go:45-50`
**说明**: SPEC定义返回 `{token, expires_at}`，实际返回 `{token}`
**影响**: 前端解析错误
**建议**: 添加 `expires_at` 字段

#### 2. [调试规范] 缺少错误日志
**位置**: `src/auth/service.go:78`
**说明**: 错误处理中只有 `return err`，没有日志记录
**影响**: 问题排查困难
**建议**: 添加 `log.Errorf("用户登录失败: %v", err)`

---

### 🟡 主要问题（建议修复）

#### 1. [代码质量] 函数过长
**位置**: `src/auth/service.go:30-120`
**说明**: `LoginUser` 函数90行，超过50行限制
**影响**: 可读性和可维护性降低
**建议**: 提取子函数 `validateCredentials()`, `generateToken()`

---

### 🟢 次要问题（可选优化）

#### 1. [代码质量] 注释不足
**位置**: `src/auth/service.go:55`
**说明**: 复杂逻辑缺少注释说明
**影响**: 代码理解难度增加
**建议**: 添加注释说明业务逻辑

---

## 📊 审查统计

**SPEC符合性**: 85% (部分不符合API-AUTH-001)
**代码质量**: 75% (函数过长、命名不规范)
**调试规范**: 60% (缺少日志)
**总体评分**: 73分

---

## ✅ 审查建议

1. 优先修复2个严重问题
2. 改进代码质量和调试规范
3. 重新审查验证
4. 提交代码
```

---

### 步骤4：改进建议与追踪

#### 4.1 提供改进建议

**针对每个问题提供**：
- 🔴 严重问题：必须修复 + 修复方案
- 🟡 主要问题：建议改进 + 改进示例
- 🟢 次要问题：可选优化 + 参考文档

#### 4.2 生成TODO清单

```markdown
## 修复TODO清单

### 🔴 必须修复（阻塞提交）
- [ ] 修复API响应格式（`src/auth/service.go:45-50`）
- [ ] 添加错误日志（`src/auth/service.go:78`）

### 🟡 建议修复（提升质量）
- [ ] 重构LoginUser函数（`src/auth/service.go:30-120`）
- [ ] 改进变量命名（`src/auth/validator.go:15`）

### 🟢 可选优化（锦上添花）
- [ ] 添加注释说明（`src/auth/service.go:55`）
```

---

## 🚨 核心铁律

### 铁律1：SPEC是唯一真源
- ✅ 代码审查以SPEC为唯一标准
- ❌ 不以个人偏好判断代码质量
- ⚠️ 代码与SPEC不一致时，改代码不改SPEC

### 铁律2：全面暴露，一次根治
- ✅ 识别所有相关问题，不遗漏
- ✅ 提供完整的修复方案
- ❌ 禁止"先修复表面，之后再补"

### 铁律3：基于角色规范审查
- ✅ 使用 quality.md 的标准
- ✅ 使用 debugger.md 的标准
- ✅ 使用 common.md 的标准
- ❌ 不凭空制定审查标准

### 铁律4：建设性审查
- ✅ 提供明确的修复建议
- ✅ 给出具体的代码示例
- ❌ 避免模糊的"改进"建议

---

## 📊 审查输出

### 输出格式

**Markdown报告**（推荐）：
- 完整的审查报告
- 问题分类和优先级
- 具体的修复建议

**简洁输出**（可选）：
- 问题清单
- 严重程度统计
- 快速修复建议

### 输出渠道

| 场景 | 输出方式 |
|------|---------|
| **命令行调用** | 输出到终端 |
| **PR审查** | 评论到PR |
| **文件审查** | 生成报告文件 |

---

## 🔧 技术实现

### 调用Explore工具

**时机**：步骤1.1（代码变更分析）

**目的**：深度分析代码变更，识别影响范围

### 调用architect/programmer

**时机**：发现需要更新SPEC时

**目的**：同步更新SPEC文档

---

## 📋 使用示例

### 示例1：审查当前分支

```
用户：/review

review：正在检测变更范围...
review：发现5个文件变更，237行修改
review：正在读取SPEC文档...
review：正在进行多维度审查...

review：📋 代码审查报告
review：- 🔴 严重问题：2个
review：- 🟡 主要问题：3个
review：- 🟢 次要问题：1个

review：建议优先修复严重问题
review：是否生成修复TODO清单？

用户：是

review：已生成修复清单
review：下一步：修复问题 → 重新审查 → 提交
```

### 示例2：PR审查

```
用户：/review --pr 123

review：正在审查PR #123...
review：获取PR差异...
review：分析代码变更...

review：审查完成！
review：已评论到PR：github.com/repo/pull/123
review：发现2个严重问题，建议修复后合并
```

---

## 版本历史
- v1.0.0 (2025-12-27): 初始版本，定义SPEC驱动的代码审查流程
